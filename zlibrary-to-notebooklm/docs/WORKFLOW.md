# 工作流程详解

## 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    Z-Library to NotebookLM                   │
│                        完整工作流程                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  1. 用户输入 Z-Library 书籍链接       │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  2. 检查本地会话状态                   │
        │     ~/.zlibrary/storage_state.json     │
        └───────────────────────────────────────┘
                     ↙              ↘
              会话存在              会话不存在
                 ↓                      ↓
    ┌──────────────────┐      ┌─────────────────┐
    │  使用已保存的会话  │      │  提示用户先登录   │
    └──────────────────┘      │  python3 login.py│
                              └─────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  3. 启动浏览器（Playwright）           │
        │     - 使用持久化上下文                 │
        │     - 加载保存的 cookies               │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  4. 访问书籍页面                       │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  5. 检测页面类型                       │
        └───────────────────────────────────────┘
                     ↙              ↘
             新版界面              旧版界面
         (三点菜单)            (转换按钮)
                 ↓                   ↓
    ┌─────────────────┐   ┌──────────────────┐
    │ 点击三点菜单     │   │ 查找转换按钮      │
    │ 选择格式         │   │ 点击转换          │
    └─────────────────┘   └──────────────────┘
                 ↘                   ↙
                  └─────────┬──────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  6. 智能选择格式                       │
        │     优先级: PDF > EPUB > 其他         │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  7. 等待转换完成（如需要）             │
        │     - 检测"转换已完成"消息             │
        │     - 最长等待 60 秒                  │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  8. 点击下载链接                      │
        │     - 使用 JavaScript 点击             │
        │     - 绕过可见性问题                   │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  9. 等待下载完成                       │
        │     - 监听下载事件                    │
        │     - 保存到 ~/Downloads/             │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  10. 格式处理                          │
        │      ↙          ↘                    │
        │   是 PDF       是 EPUB                │
        │     ↓            ↓                    │
        │  直接使用    转换为 TXT               │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  11. 创建 NotebookLM 笔记本           │
        │      - notebooklm create              │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  12. 上传内容                          │
        │      - notebooklm source add          │
        └───────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │  13. 返回笔记本 ID                     │
        │      - 用户可以立即开始使用           │
        └───────────────────────────────────────┘
                            ↓
                      ✅ 完成！
```

## 详细步骤说明

### 步骤 1-2: 初始化和会话检查

**检测会话状态：**
- 位置：`~/.zlibrary/storage_state.json`
- 内容：cookies、localStorage、sessionStorage
- 权限：600（仅所有者可读写）

**如果没有会话：**
```bash
python3 bin/login.py
```

### 步骤 3-4: 浏览器启动和页面访问

**使用 Playwright 持久化上下文：**
```python
browser = await p.chromium.launch_persistent_context(
    user_data_dir="~/.zlibrary/browser_profile",
    headless=False,
    accept_downloads=True
)
```

**优势：**
- 保留所有 cookies
- 保留浏览器缓存
- 无需重复登录

### 步骤 5-6: 页面类型检测和格式选择

**新版界面（三点菜单）：**
```python
dots_button = await page.query_selector('[class*="dots"]')
if dots_button:
    # 点击菜单，选择格式
```

**旧版界面（转换按钮）：**
```python
convert_button = await page.query_selector('a[data-convert_to="pdf"]')
if convert_button:
    # 点击转换按钮
```

**格式优先级：**
1. **PDF** ⭐ - 保留排版，无需转换
2. **EPUB** - 转换为纯文本（AI 检索最佳）
3. **其他** - 根据情况处理

### 步骤 7-8: 转换和下载

**等待转换完成：**
```python
for i in range(60):
    message = await page.query_selector('.message:has-text("转换为")')
    if '完成' in await message.inner_text():
        break
    await asyncio.sleep(1)
```

**JavaScript 点击（绕过可见性问题）：**
```python
await download_link.evaluate('el => el.click()')
```

### 步骤 9-10: 下载和格式处理

**监听下载事件：**
```python
async def handle_download(download):
    file_path = downloads_dir / download.suggested_filename
    await download.save_as(file_path)

page.on('download', handle_download)
```

**格式处理：**
- **PDF** → 直接使用
- **EPUB** → 使用 ebooklib 提取文本

### 步骤 11-12: NotebookLM 上传

**创建笔记本：**
```bash
notebooklm create "书名" --json
```

**上传内容：**
```bash
notebooklm source add "文件路径" --json
```

## 故障排除

### 问题 1: 会话过期

**症状：** 提示未登录

**解决：**
```bash
rm ~/.zlibrary/storage_state.json
python3 bin/login.py
```

### 问题 2: 找不到下载按钮

**症状：** "未找到下载链接"

**可能原因：**
- 页面结构变化
- 需要登录
- 网络问题

**解决：**
- 检查浏览器窗口
- 手动完成操作
- 截图保存用于调试

### 问题 3: 转换超时

**症状：** "转换超时"

**解决：**
- 检查网络连接
- 尝试手动点击转换
- 增加等待时间

## 最佳实践

1. **定期检查会话状态**
   ```bash
   ls -lh ~/.zlibrary/storage_state.json
   ```

2. **批量处理时添加延迟**
   ```bash
   for url in "url1" "url2" "url3"; do
       python3 bin/upload.py "$url"
       sleep 5  # 避免请求过快
   done
   ```

3. **保留原始文件**
   - 所有下载文件保存在 `~/Downloads/`
   - 转换后的文本在 `/tmp/`
   - 可以随时备份或重新处理

## 性能优化

- 使用持久化浏览器上下文（减少启动时间）
- 并发下载（批量处理时）
- 智能格式选择（优先 PDF，减少转换时间）

---

**需要帮助？** 查看 [故障排除指南](TROUBLESHOOTING.md)
